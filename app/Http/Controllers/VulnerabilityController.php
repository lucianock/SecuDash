<?php

namespace App\Http\Controllers;

use App\Services\AdvancedVulnerabilityScanner;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\View\View;

class VulnerabilityController extends Controller
{
    private $scanner;

    public function __construct(AdvancedVulnerabilityScanner $scanner)
    {
        $this->scanner = $scanner;
    }

    public function index(): View
    {
        return view('vulnerability.index');
    }

    public function scan(Request $request): JsonResponse
    {
        if (!$request->ajax()) {
            return response()->json([
                'error' => 'This endpoint only accepts AJAX requests'
            ], 400);
        }

        try {
            \Log::info('Scan request received', $request->all());
            
            // Validar la entrada
            $validated = $request->validate([
                'target_url' => 'required|url',
                'scan_type' => 'required|in:quick,full',
            ]);

            \Log::info('Validation passed', $validated);

            // Realizar el escaneo usando el servicio avanzado
            $results = $this->scanner->scan(
                $validated['target_url'],
                $validated['scan_type']
            );

            \Log::info('Scan completed', $results);

            return response()->json($results);
        } catch (\Exception $e) {
            \Log::error('Scan error', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            return response()->json([
                'error' => 'An error occurred while scanning.',
                'message' => $e->getMessage()
            ], 500);
        }
    }
} 